(function(l,r){typeof exports=="object"&&typeof module<"u"?module.exports=r():typeof define=="function"&&define.amd?define(r):(l=typeof globalThis<"u"?globalThis:l||self,l["gif-decoder"]=r())})(this,function(){"use strict";var T=Object.defineProperty;var O=(l,r,c)=>r in l?T(l,r,{enumerable:!0,configurable:!0,writable:!0,value:c}):l[r]=c;var o=(l,r,c)=>(O(l,typeof r!="symbol"?r+"":r,c),c);class l{constructor(t,e){o(this,"dataView");o(this,"offset");o(this,"endianess");this.dataView=t,this.offset=0,this.endianess=e}readUint8(){const t=this.dataView.getUint8(this.offset);return this.offset++,t}readUint16(){const t=this.dataView.getUint16(this.offset,this.endianess);return this.offset+=2,t}slice(t,e){return new Uint8Array(this.dataView.buffer,t,e)}setOffset(t){this.offset=t}}class r{constructor(){o(this,"bitOffset");o(this,"byteOffset");o(this,"bytes");this.bitOffset=0,this.byteOffset=0,this.bytes=new Uint8Array}setBytes(t){if(this.hasBits(1)){const e=this.bytes.byteLength-this.byteOffset,s=new Uint8Array(e+t.byteLength);s.set(this.bytes.slice(this.byteOffset)),s.set(t,e),this.bytes=s,this.byteOffset=0}else this.bitOffset=0,this.byteOffset=0,this.bytes=t}hasBits(t){return 8*(this.bytes.byteLength-this.byteOffset)-this.bitOffset>t}readBits(t){let e=0,s=0;for(;s<t;){const a=Math.min(8-this.bitOffset,t-s);e+=(255>>8-a<<this.bitOffset&this.bytes[this.byteOffset])>>this.bitOffset<<s,s+=a,this.bitOffset+=a,this.bitOffset===8&&(this.bitOffset=0,this.byteOffset++)}return e}}function c(n){let t="";for(let e=7;e>=0;e--)t+=(n&1<<e)>>e;return t}class F{constructor(t){o(this,"stream");o(this,"header");o(this,"logicScreen");o(this,"globalColor");o(this,"applications");o(this,"comments");o(this,"graphControls");o(this,"plainTexts");o(this,"imgs");this.setStream(t),this.setGlobal(),this.setLocal()}setStream(t){this.stream=new l(t,!0)}setGlobal(){this.header=this.getHeader(),this.logicScreen=this.getLogicScreen();const{globalColorTableFlag:t,globalColorTableSize:e}=this.logicScreen.packageField;this.globalColor=this.getColor(t,e)}setLocal(){this.plainTexts=[],this.graphControls=[],this.comments=[],this.applications=[],this.imgs=[];const{stream:t}=this;for(;t.offset<t.dataView.byteLength;){let e=t.readUint8();e===33?this.setExtension():e===44&&this.setImg()}}getHeader(){let t="";for(let e=0;e<6;e++)t+=String.fromCharCode(this.stream.readUint8());return t}getLogicScreen(){const{stream:t}=this,e={canvasWidth:0,canvasHeight:0,packageField:{globalColorTableFlag:0,colorResolution:0,sortFlag:0,globalColorTableSize:0},bgColorIndex:0,pxAspectRadio:0};e.canvasWidth=t.readUint16(),e.canvasHeight=t.readUint16();const s=t.readUint8();let a=c(s);return e.packageField={globalColorTableFlag:parseInt(a[0],2),colorResolution:parseInt(a.slice(1,4),2),sortFlag:parseInt(a[4],2),globalColorTableSize:parseInt(a.slice(5,8),2)},e.bgColorIndex=t.readUint8(),e.pxAspectRadio=t.readUint8(),e}setExtension(){const{stream:t}=this;switch(t.readUint8()){case 1:this.plainTexts.push(this.getPlainText());break;case 249:this.graphControls.push(this.getGraphControl());break;case 254:this.comments.push(this.getComment());break;case 255:this.applications.push(this.getApplication());break}if(t.readUint8()!==0)throw new Error("EOF \u89E3\u6790\u51FA\u9519\uFF01\uFF01\uFF01")}setImg(){const t={imgScreen:{left:0,right:0,width:0,height:0,packageField:{localColorTableFlag:0,interlaceFlag:0,sortFlag:0,unUse:0,localColorTableSize:0}},localColor:[],data:{colorSpace:"srgb",data:new Uint8ClampedArray,height:0,width:0}};t.imgScreen=this.getImgScreen();const{localColorTableFlag:e,localColorTableSize:s}=t.imgScreen.packageField;t.localColor=this.getColor(e,s),t.data=this.getImgData(t.imgScreen,t.localColor.length?t.localColor:this.globalColor),this.imgs.push(t)}getImgScreen(){const{stream:t}=this,e={left:0,right:0,width:0,height:0,packageField:{localColorTableFlag:0,interlaceFlag:0,sortFlag:0,unUse:0,localColorTableSize:0}};e.left=t.readUint16(),e.right=t.readUint16(),e.width=t.readUint16(),e.height=t.readUint16();let s=c(t.readUint8());return e.packageField={localColorTableFlag:parseInt(s[0],2),interlaceFlag:parseInt(s[1],2),sortFlag:parseInt(s[2],2),unUse:parseInt(s.slice(3,5),2),localColorTableSize:parseInt(s.slice(5,8),2)},e}getPlainText(){const{stream:t}=this;let e=t.readUint8(),s="";for(;e;)s+=String.fromCharCode(t.readUint8()),e--;return s}getGraphControl(){const{stream:t}=this,e={dataSize:0,packageField:{unUse:0,disposalMethod:0,userInputFlag:0,transparentColorFlag:0},delayTime:0,transparentColorIndex:0};e.dataSize=t.readUint8();const s=c(t.readUint8());return e.packageField={unUse:parseInt(s.slice(0,3),2),disposalMethod:parseInt(s.slice(3,6),2),userInputFlag:parseInt(s[6],2),transparentColorFlag:parseInt(s[7],2)},e.delayTime=t.readUint16(),e.transparentColorIndex=t.readUint8(),e}getComment(){const{stream:t}=this;let e=t.readUint8(),s="";for(;e;)s+=String.fromCharCode(t.readUint8()),e--;return s}getApplication(){const{stream:t}=this;let e=t.readUint8(),s="";for(;e;)s+=String.fromCharCode(t.readUint8()),e--;let a=t.readUint8();for(;a;)t.readUint8(),a--;return s}getImgData(t,e){const{stream:s}=this,a=[],b=s.readUint8();let d=s.readUint8(),u=[];for(;d;)u.push(s.slice(s.offset,d)),s.setOffset(s.offset+d),d=s.readUint8();const f=new r;let h=[],i=[];const y=1<<b,w=(1<<b)+1;let m=b+1,U=!1;return u.forEach(I=>{f.setBytes(I);let S=(1<<m)-1;for(;f.hasBits(m);){let p=f.readBits(m);if(p===w){h.push(p);break}else if(p===y){h=[],i=[];for(let g=0;g<=w;g++)i[g]=g<y?[g]:[];U=!1}else if(!U)a.push(...i[p]),U=!0;else{let g=h[h.length-1],C=0;p<=i.length-1?(a.push(...i[p]),C=i[p][0]):(C=i[g][0],a.push(...i[g],C)),i.length-1<4095&&(i.push([...i[g],C]),i.length-1===S&&i.length-1<4095&&(m++,S=(1<<m)-1))}h.push(p)}}),this.handleImg(t,e,a)}handleImg(t,e,s){const{width:a,height:b}=t,d=document.createElement("canvas");d.width=a,d.height=b;const u=d.getContext("2d"),f=u==null?void 0:u.createImageData(a,b),h=f==null?void 0:f.data;for(let i=0;i<s.length;i++)h[i*4+0]=e[s[i]][0],h[i*4+1]=e[s[i]][1],h[i*4+2]=e[s[i]][2],h[i*4+3]=255;return f}getColor(t,e){const{stream:s}=this;return t?this.getColorTable(s,(2<<e)*3):[]}getColorTable(t,e){const s=[];for(;e;){const a=[t.readUint8(),t.readUint8(),t.readUint8()];s.push(a),e-=3}return s}}return fetch("http://cloudstorage.ihubin.com/blog/audio-video/blog-17/rainbow.gif").then(n=>n.arrayBuffer()).then(n=>new DataView(n)).then(n=>{console.log(new F(n))}),F});
