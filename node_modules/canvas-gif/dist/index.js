"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const gm_1=__importDefault(require("gm")),decode_gif_1=__importDefault(require("decode-gif")),fs_1=__importDefault(require("fs")),canvas_1=require("canvas"),gif_encoder_2_1=__importDefault(require("gif-encoder-2"));function coalesce(e){var a,r=null;return gm_1.default(e).coalesce().toBuffer(async(e,t)=>{e&&(a=e),r=t||void 0}),new Promise(n);function n(e,t){r&&0<r.length?e(r):void 0===r?t(new Error(`There was an error during coalescing: ${a.message}. Reverting to file buffer!`)):setTimeout(n.bind(this,e,t),30)}}module.exports=async function(t,n,e){var a,r=e?.coalesce??!1,o=e?.algorithm?.toLowerCase()??"neuquant",i=e?.optimiser??!1,s=e?.delay??0,u=e?.repeat??0,c=e?.fps??60,e=e?.quality/100??1;r?await coalesce(t).then(e=>{a=e}).catch(e=>{console.log(e),a="string"==typeof t?fs_1.default.readFileSync(t):t}):a="string"==typeof t?fs_1.default.readFileSync(t):t,["neuquant","octree"].includes(o)||(console.error(new Error(o+" is not a valid algorithm! Using neuquant as a substitute.")),o="neuquant");const{width:l,height:f,frames:d}=decode_gif_1.default(a),_=new gif_encoder_2_1.default(l,f,o,i,d.length);return _.on("readable",()=>_.read()),_.setDelay(s),_.setRepeat(u),_.setFrameRate(c),_.setQuality(e),_.start(),d.forEach((e,t)=>{const a=canvas_1.createCanvas(l,f),r=a.getContext("2d");e=canvas_1.createImageData(e.data,l,f);r.putImageData(e,0,0),n(r,l,f,d.length,t+1,_),_.addFrame(r)}),_.finish(),_.out.getData()};